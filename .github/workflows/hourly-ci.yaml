# This workflow runs tests on a schedule and can also be triggered manually.
# It is designed to run each test suite in parallel for faster execution.

name: Hourly Commit Check and Tests

on:
  # Schedule the workflow to run every 4 hours
  schedule:
    # Runs at minute 0, every 4th hour (0, 4, 8, 12, 16, 20 UTC)
    - cron: '0 */4 * * *'

  # Allow manual triggering from the GitHub Actions UI
  workflow_dispatch: {}

jobs:
  # JOB 1: (NEW) Discovers an available runner and locks it for all subsequent jobs.
  discover_runner:
    runs-on: hourly-ci # Picks any available runner from the 'hourly-ci' pool
    outputs:
      runner_name: ${{ steps.get_name.outputs.name }}
    steps:
      - name: Get runner name
        id: get_name
        # This command gets the unique name of the runner (e.g., "my-runner-123")
        # and saves it as an output variable
        run: |
          echo "This workflow will run on: ${{ runner.name }}"
          echo "name=${{ runner.name }}" >> "$GITHUB_OUTPUT"

  # JOB 2: (UPDATED) Sets up the environment and builds the Docker image.
  setup_and_build:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.ref == 'refs/heads/main'
    # <-- UPDATED: Now needs 'discover_tests' AND 'discover_runner'
    needs: [discover_tests, discover_runner]
    # <-- UPDATED: Runs on the specific runner from the discover_runner job
    runs-on: ${{ needs.discover_runner.outputs.runner_name }}
    permissions:
      contents: read # Required to checkout code and read history
    outputs:
      latest_commit: ${{ steps.latest_vllm_commit.outputs.LATEST_COMMIT }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for accurate commit comparison
          fetch-depth: 0

      - name: Pre-Job Workspace Cleanup
        if: always()
        run: |
          echo "Attempting to remove remote branch if it exists..."
          git remote remove vllm-upstream || true
          echo "Cleanup complete."

      - name: Clean and Checkout repository again
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true # Ensure a clean workspace before checkout

      - name: Add vLLM upstream as a remote and fetch its history
        run: |
          git remote add vllm-upstream https://github.com/vllm-project/vllm.git
          git fetch vllm-upstream --depth=100

      - name: Calculate previous run time
        id: prev_run_time
        run: |
          PREV_RUN_TIME=$(date -u -d "4 hours ago" +"%Y-%m-%dT%H:%M:%SZ")
          echo "Looking for commits since: $PREV_RUN_TIME"
          echo "PREV_RUN_TIME=$PREV_RUN_TIME" >> "$GITHUB_OUTPUT"

      - name: List commit differences in the last 4 hours
        run: |
          echo "Commits merged/pushed in vllm-project/vllm.git in the last 4 hours:"
          git log HEAD..vllm-upstream/main --pretty=format:"%h - %an, %ar : %s" --since="${{ steps.prev_run_time.outputs.PREV_RUN_TIME }}"

      - name: Get latest commit sha from vllm-upstream/main
        id: latest_vllm_commit
        run: |
          # Use the 'vllm-upstream/main' ref to log latest commit from that remote
          LATEST_COMMIT=$(git rev-parse vllm-upstream/main)
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> "$GITHUB_OUTPUT"
          echo "Latest commit from upstream vLLM: $LATEST_COMMIT"

      - name: Setup Docker environment and build image
        run: |
          echo "Attempting to build Docker image..."
          docker build --no-cache -t hpu-plugin-v1-test-env-hourly-ci -f - . <<EOF
          FROM vault.habana.ai/gaudi-docker/1.23.0/ubuntu24.04/habanalabs/pytorch-installer-2.9.0:latest

          COPY ./ /workspace/vllm-gaudi
          WORKDIR /workspace

          RUN git clone https://github.com/vllm-project/vllm.git vllm
          WORKDIR /workspace/vllm
          RUN git checkout ${{ steps.latest_vllm_commit.outputs.LATEST_COMMIT }}

          RUN pip install pytest pytest_asyncio pytest-timeout
          RUN pip install git+https://github.com/EleutherAI/lm-evaluation-harness.git

          ENV no_proxy=localhost,127.0.0.1
          ENV PT_HPU_ENABLE_LAZY_COLLECTIVES=true

          RUN bash -c 'pip install -r <(sed "/^[torch]/d" requirements/build.txt)'
          RUN VLLM_TARGET_DEVICE=empty pip install --no-build-isolation .

          RUN python3 -m pip install -e tests/vllm_test_utils

          WORKDIR /workspace/vllm-gaudi
          RUN pip install -e .

          WORKDIR /workspace
          RUN ln -s /workspace/vllm/tests /workspace/tests \
              && ln -s /workspace/vllm/examples /workspace/examples \
              && ln -s /workspace/vllm/benchmarks /workspace/benchmarks
          EOF
          echo "Docker image built successfully."

  # JOB 3: (UPDATED)
  run_unit_tests:
    # <-- UPDATED: Now needs 'setup_and_build' AND 'discover_runner'
    needs: [setup_and_build, discover_runner]
    # <-- UPDATED: Runs on the specific runner
    runs-on: ${{ needs.discover_runner.outputs.runner_name }}
    steps:
      - name: Run pytest in tests/unit_tests
        run: |
          EXITCODE=1
          remove_docker_containers() { docker rm -f hpu-plugin-v1-test-unit-tests-hourly-ci || true; }
          trap 'remove_docker_containers; exit $EXITCODE;' EXIT
          remove_docker_containers

          echo "Running HPU plugin v1 unit tests"
          docker run --rm --runtime=habana --name=hpu-plugin-v1-test-unit-tests-hourly-ci --network=host \
            -e HABANA_VISIBLE_DEVICES=all \
            -e HF_HOME=/workspace/hf_cache \
            -e HF_TOKEN=${{ secrets.HF_TOKEN }} \
            -v /mnt/hf_cache:/workspace/hf_cache \
            hpu-plugin-v1-test-env-hourly-ci \
            /bin/bash -c "pytest -vvv --timeout=300 --durations=10 --durations-min=1.0 /workspace/vllm-gaudi/tests/unit_tests"

          EXITCODE=$?
          echo "Test script exited with code: $EXITCODE"

  # JOB 4: (UPDATED)
  discover_tests:
    # <-- UPDATED: Now needs 'discover_runner'
    needs: discover_runner
    # <-- UPDATED: Runs on the specific runner
    runs-on: ${{ needs.discover_runner.outputs.runner_name }}
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Discover test functions
        id: set-matrix
        run: |
          # Use the script's built-in discover_matrix to generate a 2D matrix
          # of {test_function, mode} objects. Each test declares its supported
          # execution modes (lazy, eager, or both) via EAGER_ONLY_TESTS / LAZY_ONLY_TESTS
          # arrays in ci_gsm8k_tests.sh. Tests supporting both modes appear twice.
          MATRIX=$(bash ./tests/full_tests/ci_gsm8k_tests.sh discover_matrix)

          echo "Discovered test matrix: $MATRIX"
          # Fail the job if no tests were found.
          if [ "$MATRIX" = "[]" ]; then
            echo "::error::No test functions were discovered. Failing the workflow."
            exit 1
          fi
          echo "matrix={\"include\":${MATRIX}}" >> "$GITHUB_OUTPUT"

  # JOB 5: (UPDATED)
  e2e:
    # <-- UPDATED: Now needs 'setup_and_build', 'discover_tests', AND 'discover_runner'
    needs: [setup_and_build, discover_tests, discover_runner]
    # <-- UPDATED: Runs on the specific runner
    runs-on: ${{ needs.discover_runner.outputs.runner_name }}
    strategy:
      fail-fast: false
      matrix:
        # 2D matrix of {test_function, mode} objects dynamically populated from discover_tests.
        # Each test runs in its compatible mode(s): lazy (PT_HPU_LAZY_MODE=1), eager (PT_HPU_LAZY_MODE=0), or both.
        ${{ fromJson(needs.discover_tests.outputs.matrix) }}

    steps:
      - name: Run test suite - ${{ matrix.test_function }} (${{ matrix.mode }})
        run: |
          EXITCODE=1
          CONTAINER_NAME="hpu-plugin-test-${{ matrix.test_function }}-${{ matrix.mode }}-${{ github.run_id }}"
          # Ensure the container is removed upon exit, regardless of success or failure.
          remove_docker_containers() { docker rm -f $CONTAINER_NAME || true; }
          trap 'remove_docker_containers; exit $EXITCODE;' EXIT
          remove_docker_containers

          # Map mode name to PT_HPU_LAZY_MODE value: lazy=1, eager=0
          MODE_VALUE=$([[ "${{ matrix.mode }}" == "lazy" ]] && echo "1" || echo "0")

          echo "Running HPU plugin test: ${{ matrix.test_function }} (mode=${{ matrix.mode }}, PT_HPU_LAZY_MODE=${MODE_VALUE})"
          docker run --rm --runtime=habana --name=$CONTAINER_NAME --network=host \
            --privileged \
            -e HABANA_VISIBLE_DEVICES=all \
            -e PT_HPU_LAZY_MODE=${MODE_VALUE} \
            -e HF_HOME=/workspace/hf_cache \
            -e HF_TOKEN=${{ secrets.HF_TOKEN }} \
            -v /mnt/hf_cache:/workspace/hf_cache \
            hpu-plugin-v1-test-env-hourly-ci \
            /bin/bash "/workspace/vllm-gaudi/tests/full_tests/ci_gsm8k_tests.sh" "${{ matrix.test_function }}"

          EXITCODE=$?
          echo "Test script exited with code: $EXITCODE"

  # JOB 6: (UPDATED)
  run_data_parallel_test:
    # <-- UPDATED: Now needs 'setup_and_build' AND 'discover_runner'
    needs: [setup_and_build, discover_runner]
    # <-- UPDATED: Runs on the specific runner
    runs-on: ${{ needs.discover_runner.outputs.runner_name }}
    steps:
      - name: Run Data Parallel test
        run: |
          EXITCODE=1
          remove_docker_containers() { docker rm -f hpu-plugin-v1-test-dp-tests-hourly-ci || true; }
          trap 'remove_docker_containers; exit $EXITCODE;' EXIT
          remove_docker_containers

          echo "Running HPU plugin v1 dp tests"
          docker run --rm --runtime=habana --name=hpu-plugin-v1-test-dp-tests-hourly-ci --network=host \
            --privileged \
            -e HABANA_VISIBLE_DEVICES=all \
            -e HF_HOME=/workspace/hf_cache \
            -e VLLM_SKIP_WARMUP=true \
            -e PT_HPU_LAZY_MODE=1 \
            -e HF_TOKEN=${{ secrets.HF_TOKEN }} \
            -v /mnt/hf_cache:/workspace/hf_cache \
            hpu-plugin-v1-test-env-hourly-ci \
            /bin/bash -c "python -u /workspace/vllm-gaudi/examples/data_parallel.py --dp-size 2 --tp-size 2"

          EXITCODE=$?
          echo "Test script exited with code: $EXITCODE"

  # JOB 7: (UPDATED)
  run_pd_disaggregate_test:
    # <-- UPDATED: Now needs 'setup_and_build' AND 'discover_runner'
    needs: [setup_and_build, discover_runner]
    # <-- UPDATED: Runs on the specific runner
    runs-on: ${{ needs.discover_runner.outputs.runner_name }}
    steps:
      - name: Run PD disaggregate test
        run: |
          EXITCODE=1
          remove_docker_containers() { docker rm -f hpu-plugin-v1-test-pd-tests-hourly-ci || true; }
          trap 'remove_docker_containers; exit $EXITCODE;' EXIT
          remove_docker_containers

          echo "Running HPU plugin v1 nixl pd tests"
          docker run --rm --runtime=habana --name=hpu-plugin-v1-test-pd-tests-hourly-ci --network=host \
            --privileged \
            -e HABANA_VISIBLE_DEVICES=all \
            -e HF_HOME=/workspace/hf_cache \
            -e HF_TOKEN=${{ secrets.HF_TOKEN }} \
            -v /mnt/hf_cache:/workspace/hf_cache \
            -v /mnt/wheels_cache:/tmp/wheels_cache \
            hpu-plugin-v1-test-env-hourly-ci \
            /bin/bash -c "
              pip install lm-eval[api] &&
              cd /workspace/vllm-gaudi/tests/unit_tests &&
              ./run_accuracy_test.sh
            "
          EXITCODE=$?
          echo "Test script exited with code: $EXITCODE"
  
  # JOB 8: (UPDATED)
  store_last_stable_vllm_commit:
    # <-- UPDATED: Now needs all test jobs AND 'discover_runner'
    needs: [setup_and_build, run_unit_tests, e2e, run_data_parallel_test, run_pd_disaggregate_test, discover_runner]
    # <-- UPDATED: Runs on the specific runner
    runs-on: ${{ needs.discover_runner.outputs.runner_name }}
    permissions:
      contents: write # Permission is required to push a commit
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: vllm/last-good-commit-for-vllm-gaudi
          fetch-depth: 0 # Fetch full history to ensure we can push changes

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Store last stable vllm commit sha
        run: |
          LATEST_COMMIT_SHA=${{ needs.setup_and_build.outputs.latest_commit }}
          echo "Storing latest stable vLLM commit SHA: $LATEST_COMMIT_SHA"
          echo "$LATEST_COMMIT_SHA" > VLLM_STABLE_COMMIT
          
          # Only commit and push if the file has changed to avoid empty commits
          git add VLLM_STABLE_COMMIT
          git commit --allow-empty -m "Update stable vLLM commit to ${LATEST_COMMIT_SHA}"
          
          echo "Pushing changes to remote branch..."
          # Explicitly set the remote URL with the token to prevent hanging on auth
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git push --force origin HEAD:vllm/last-good-commit-for-vllm-gaudi
