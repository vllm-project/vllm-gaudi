name: Update Review Dashboard

on:
  schedule:
    - cron: '*/30 * * * *' # Runs every 30 minutes
  workflow_dispatch: # Allows manual trigger

permissions:
  issues: write
  pull-requests: read

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Dashboard Content
        id: dashboard
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          # 1. Initialize the Body File
          echo "# ðŸš¦ Live Review Dashboard" > body.md
          echo "_Last updated: $(date)_" >> body.md
          echo "_Note: Draft PRs are hidden._" >> body.md
          echo "" >> body.md

          # 2. Fetch ALL open PRs
          # We fetch isDraft so we can filter it out in the next steps
          gh pr list --repo $REPO --limit 100 --state open \
            --json number,title,author,assignees,url,createdAt,reviewDecision,statusCheckRollup,isDraft > pr_data.json

          # ----------------------------------------------
          # 3. UNASSIGNED PRs TABLE
          # ----------------------------------------------
          echo "### âš ï¸ Unassigned PRs" >> body.md
          echo "| PR | Age | Status | Title | Author |" >> body.md
          echo "| :--- | :--- | :--- | :--- | :--- |" >> body.md
          
          # JQ Filter: select(.isDraft == false) AND select(no assignees)
          jq -r '.[] | select(.isDraft == false) | select(.assignees | length == 0) | 
            "| <a href=\"\(.url)\">#\(.number)</a> | 
            \((now - (.createdAt | fromdate)) / 86400 | floor) days | 
            \(if .reviewDecision == "APPROVED" then "âœ… Approved" 
              elif .statusCheckRollup.state == "FAILURE" then "âŒ CI Failed" 
              elif .statusCheckRollup.state == "SUCCESS" then "ðŸ’š CI Passed" 
              else "ðŸŸ¡ Pending" end) | 
            \(.title) | @\(.author.login) |"' pr_data.json >> body.md
          
          echo "" >> body.md

          # ----------------------------------------------
          # 4. GROUPED BY ASSIGNEE
          # ----------------------------------------------
          
          # Get unique assignees (excluding those who only have Draft PRs)
          # We first filter out drafts, THEN grab the assignees
          ASSIGNEES=$(jq -r '.[] | select(.isDraft == false) | .assignees[].login' pr_data.json | sort | uniq)

          for USER in $ASSIGNEES; do
            echo "### ðŸ‘¤ Assigned to: @$USER" >> body.md
            echo "| PR | Age | Status | Title | Author |" >> body.md
            echo "| :--- | :--- | :--- | :--- | :--- |" >> body.md
            
            # JQ Filter: select(.isDraft == false) AND select(specific user)
            jq -r --arg USER "$USER" '.[] | select(.isDraft == false) | select(.assignees[].login == $USER) | 
              "| <a href=\"\(.url)\">#\(.number)</a> | 
              \((now - (.createdAt | fromdate)) / 86400 | floor) days | 
              \(if .reviewDecision == "APPROVED" then "âœ… Approved" 
                elif .statusCheckRollup.state == "FAILURE" then "âŒ CI Failed" 
                elif .statusCheckRollup.state == "SUCCESS" then "ðŸ’š CI Passed" 
                else "ðŸŸ¡ Pending" end) | 
              \(.title) | @\(.author.login) |"' pr_data.json >> body.md
            
            echo "" >> body.md
          done

          # 5. Save to Environment Variable
          echo "BODY_CONTENT<<EOF" >> $GITHUB_ENV
          cat body.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Update Issue Body
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: 15  # <--- REPLACE WITH YOUR ISSUE NUMBER
          body: ${{ env.BODY_CONTENT }}
          edit-mode: replace
