name: Update Review Dashboard

on:
  schedule:
    - cron: '*/30 * * * *' # Runs every 30 minutes
  workflow_dispatch: # Allows manual trigger

permissions:
  issues: write
  pull-requests: read

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Dashboard Content
        id: dashboard
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          # 1. Fetch Data First (into a separate JSON file)
          gh pr list --repo "$REPO" --limit 100 --state open \
            --json number,title,author,assignees,url,createdAt,reviewDecision,statusCheckRollup,isDraft > pr_data.json

          # 2. Generate the Body File
          {
            echo "# üö¶ Live Review Dashboard"
            echo "_Last updated: $(date)_"
            echo "_Note: Draft PRs are hidden._"
            echo ""

            # --- Unassigned Section ---
            echo "### ‚ö†Ô∏è Unassigned PRs"
            echo "| PR | Age | Status | Title | Author |"
            echo "| :--- | :--- | :--- | :--- | :--- |"
            
            # FIXED: Added safe navigation (?) and array fallback for statusCheckRollup
            jq -r '.[] | select(.isDraft == false) | select(.assignees | length == 0) | 
              "| <a href=\"\(.url)\">#\(.number)</a> | \((now - (.createdAt | fromdate)) / 86400 | floor) days | \(if .reviewDecision == "APPROVED" then "‚úÖ Approved" elif (.statusCheckRollup.state? // .statusCheckRollup[0]?.state?) == "FAILURE" then "‚ùå CI Failed" elif (.statusCheckRollup.state? // .statusCheckRollup[0]?.state?) == "SUCCESS" then "üíö CI Passed" else "üü° Pending" end) | \(.title) | @\(.author.login) |"' pr_data.json
            
            echo ""

            # --- Assigned Section (Streaming Loop) ---
            jq -r '.[] | select(.isDraft == false) | .assignees[].login' pr_data.json | sort | uniq | while read -r USER; do
              # FIXED: Added safe navigation (?) and array fallback for statusCheckRollup
              jq -r --arg USER "$USER" '.[] | select(.isDraft == false) | select(.assignees[].login == $USER) | 
                "| <a href=\"\(.url)\">#\(.number)</a> | \((now - (.createdAt | fromdate)) / 86400 | floor) days | \(if .reviewDecision == "APPROVED" then "‚úÖ Approved" elif (.statusCheckRollup.state? // .statusCheckRollup[0]?.state?) == "FAILURE" then "‚ùå CI Failed" elif (.statusCheckRollup.state? // .statusCheckRollup[0]?.state?) == "SUCCESS" then "üíö CI Passed" else "üü° Pending" end) | \(.title) | @\(.author.login) |"' pr_data.json
              
              echo ""
            done
            
            # --- CRITICAL: Add Hidden Marker ---
            echo ""

          } > body.md

          # 3. Save to Env Variable
          {
            echo "BODY_CONTENT<<EOF"
            cat body.md
            echo "EOF"
          } >> "$GITHUB_ENV"

      # Step 3: Find the previous comment (if it exists)
      - name: Find Previous Comment
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: 701      # <--- TARGET ISSUE NUMBER
          body-includes: # Step 4: Create new or Update existing comment
      - name: Create or Update Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: 701      # <--- TARGET ISSUE NUMBER
          body: ${{ env.BODY_CONTENT }}
          edit-mode: replace
